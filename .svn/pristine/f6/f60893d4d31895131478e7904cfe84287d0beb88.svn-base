//
//  RegularEntrustVC.m
//  YuanXin_Project
//
//  Created by Yuanin on 16/5/3.
//  Copyright © 2016年 yuanxin. All rights reserved.
//

#import "RegularEntrustVC.h"

#import "WebVC.h"

#import "RegularInfoView.h"
#import "PickerAccessoryView.h"
#import "LimitTextField.h"

#import "BaseViewModel.h"
#import "ExclusiveButton.h"
#import "SinglePickerView.h"
#import "AlertViewManager.h"
@interface RegularEntrustVC () <UITextFieldDelegate>

//@property (strong, nonatomic) NSArray       *regularInfo;
@property (strong, nonatomic) BaseViewModel *baseViewModel;
//@property (strong, nonatomic) UIDatePicker  *datePicker;
//@property (strong, nonatomic) NSDateFormatter *dateFormat;
//
//@property (strong, nonatomic) IBOutlet ExclusiveButton *exclusiveButtons;
//@property (weak, nonatomic) IBOutlet UIScrollView *contentView;
//@property (weak, nonatomic) IBOutlet UIButton *saveAndEntrust;
////@property (strong, nonatomic) IBOutletCollection(RegularInfoView) NSArray<RegularInfoView *> *regularInfoViews;
//
//@property (weak, nonatomic) IBOutlet LimitTextField *entrustMoney;
//@property (weak, nonatomic) IBOutlet UITextField *entrustTime;
//@property (weak, nonatomic) IBOutlet UILabel *balance;
@property (weak, nonatomic) IBOutlet UITextField *PlanNameTF;

@property (weak, nonatomic) IBOutlet UITextField *YearsRateTF;
@property (weak, nonatomic) IBOutlet UITextField *TimeTF;

@property (weak, nonatomic) IBOutlet UIButton *AllMoneyBtn;

@property (weak, nonatomic) IBOutlet UIButton *SingleMoneyBtn;
@property (weak, nonatomic) IBOutlet UITextField *MoneyTF;

@property (weak, nonatomic) IBOutlet UISwitch *useRedSwitch;

@property (weak, nonatomic) IBOutlet NSLayoutConstraint *singleMoneyLBHeight;
@property (weak, nonatomic) IBOutlet UILabel *promotLB;


@property (strong, nonatomic) SinglePickerView *aprPickerView;
@property (strong, nonatomic) SinglePickerView *dayPickerView;
@property (strong, nonatomic) IBOutletCollection(UITextField) NSArray *userInterFace;

@end


@implementation RegularEntrustVC

- (void)viewDidLoad {
    [super viewDidLoad];
    [self initUI];


    [self layoutNavigationLeftButtonWithImage:[UIImage imageNamed:Nav_Back_Image] block:^(__kindof UIViewController *viewController) {
        [viewController.navigationController popViewControllerAnimated:YES];
    }];
    

}
- (void)initUI{
    self.PlanNameTF.delegate  = self;
    [_PlanNameTF addTarget:self action:@selector(RestrictTextFieldLength:)
              forControlEvents:UIControlEventEditingChanged];
    self.YearsRateTF.delegate  = self;
    self.MoneyTF.delegate  = self;
    self.singleMoneyLBHeight.constant = 0;
  
    NSMutableAttributedString *noteStr = [[NSMutableAttributedString alloc] initWithString:@"设置以下投资条件，充值或投资回款2小时内未提现以及投资的资金，系统将自动为您投资"];
    NSRange redRange = NSMakeRange([[noteStr string] rangeOfString:@"2小时内"].location, [[noteStr string] rangeOfString:@"2小时内"].length);
    [noteStr addAttribute:NSForegroundColorAttributeName value:[UIColor redColor] range:redRange];
    

    
    [self.promotLB setAttributedText:noteStr];
}
- (void)viewDidDisappear:(BOOL)animated {
    [super viewDidDisappear:animated];
    
    [self.baseViewModel cancelFetchOperation];
}
//点击爱米理财投资协议 和委托投资规则
- (IBAction)ClickedProtcolAimi:(id)sender {
    
    [self.navigationController pushViewController:[WebVC webVCWithWebPath:[CommonTools completeWebPathWithSubpath: Introduce_Buy ]] animated:YES];
}
- (IBAction)ClickedAimiInvestRule:(id)sender {
    
     [self.navigationController pushViewController:[WebVC webVCWithWebPath:[CommonTools completeWebPathWithSubpath: Introduct_Entrust ]] animated:YES];
   
}

- (IBAction)clickdWenHao:(id)sender {
    [AlertViewManager showInViewController:self title:@"系统会为您自动选择符合条件的最大金额的加息红包" message:nil clickedButtonAtIndex:^(id alertView, NSInteger buttonIndex) {
        
    } cancelButtonTitle:@"朕知道了" otherButtonTitles:nil, nil];
    
}
- (IBAction)clickedUseDiscountSwitchBtn:(id)sender {
}

- (IBAction)ClickedAllMoneyBtn:(id)sender {
    self.AllMoneyBtn.selected = !self.AllMoneyBtn.selected;
    if (self.AllMoneyBtn.selected) {
         self.SingleMoneyBtn.selected = !self.AllMoneyBtn.selected;
        self.singleMoneyLBHeight.constant = 0;
    }
   
}

- (IBAction)ClickedSingleMoneyBtn:(id)sender {
    self.SingleMoneyBtn.selected = !self.SingleMoneyBtn.selected;
    
      if (self.SingleMoneyBtn.selected) {
         self.AllMoneyBtn.selected = !self.SingleMoneyBtn.selected;
          self.singleMoneyLBHeight.constant = 40;
      }else{
          self.singleMoneyLBHeight.constant = 0;
      }
}



#pragma mark - delegate
- (BOOL)textFieldShouldReturn:(UITextField *)textField {
    
    [textField endEditing:YES];
    return YES;
}
//- (IBAction)RestrictTextFieldLength:(id)sender {
//    UITextField *textField = (UITextField *)sender;
//    NSString *temp = textField.text;
//    
//    if (textField.markedTextRange == nil) {
//        while(1){
//            if ([temp lengthOfBytesUsingEncoding:NSUTF8StringEncoding] <= 24) {
//                break;
//            }else {
//                temp = [temp substringToIndex:temp.length-1];
//            }
//        }
//        textField.text = temp;
//    }
//}
- (IBAction)RestrictTextFieldLength:(id)sender {
        UITextField *textField = (UITextField *)sender;
        NSString *temp = textField.text;
    
        if (textField.markedTextRange == nil) {
            while(1){
                if ([temp lengthOfBytesUsingEncoding:NSUTF8StringEncoding] <= 30) {
                    break;
                }else {
                    temp = [temp substringToIndex:temp.length-1];
                }
            }
            textField.text = temp;
        }
}


- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event{
    [self.PlanNameTF resignFirstResponder];
    [self.YearsRateTF resignFirstResponder];
    [self.MoneyTF resignFirstResponder];

  
}


- (void)setYearsRateTF:(UITextField *)YearsRateTF {
    
    _YearsRateTF = YearsRateTF;
    NSArray *arr = @[@[@"不限",@"7",@"8",@"9",@"10",@"11",@"12",@"13"],@[@"不限",@"7",@"8",@"9",@"10",@"11",@"12",@"13"]];
    self.aprPickerView.pickerInfo = arr;
        _YearsRateTF.inputView = self.aprPickerView;
    
        __weak UITextField *weak_text = _YearsRateTF;
        @weakify(self)
        _YearsRateTF.inputAccessoryView = [PickerAccessoryView pickerAccessoryViewWithDoneBlock:^{
            @strongify(self)
            [weak_text endEditing:YES];
            NSArray *arr = [self.aprPickerView selectedInfo];
            if ([arr[0] isEqualToString:arr[1]]) {
                if ([arr[0] isEqualToString:@"不限"]) {
                    weak_text.text = @"不限";
                

                }else{
                    weak_text.text = [NSString stringWithFormat:@"%@%%",arr[0]];
                    
                }
//
            }else{
                if ([arr[0] isEqualToString:@"不限"]) {
                      weak_text.text = [NSString stringWithFormat:@"7%%~%@%%",arr[1]];
                }else{
                     weak_text.text = [NSString stringWithFormat:@"%@%%~%@%%",arr[0],arr[1]];
                }
                
            }
           
        } cancelBlock:^{
            [weak_text endEditing:YES];
        }];
        
        UIView *paddingView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 10, 20)];
        _YearsRateTF.leftView = paddingView;
        _YearsRateTF.leftViewMode = UITextFieldViewModeAlways;
    
}
- (void)setTimeTF:(UITextField *)TimeTF{
    _TimeTF = TimeTF;
    NSArray *arr = @[@[@"不限",@"1",@"3",@"6",@"12",@"18",@"24"],@[@"不限",@"1",@"3",@"6",@"12",@"18",@"24"]];
    self.dayPickerView.pickerInfo = arr;
    _TimeTF.inputView = self.dayPickerView;
    
    __weak UITextField *weak_text = _TimeTF;
    @weakify(self)
    _TimeTF.inputAccessoryView = [PickerAccessoryView pickerAccessoryViewWithDoneBlock:^{
        @strongify(self)
        [weak_text endEditing:YES];
        NSArray *arr = [self.dayPickerView selectedInfo];
        if ([arr[0] isEqualToString:arr[1]]) {
            if ([arr[0] isEqualToString:@"不限"]) {
                weak_text.text = @"不限";
                
                
            }else{
                NSString * str = [NSString stringWithFormat:@"%@",arr[0]];
                NSInteger i = [str integerValue] *30;
                weak_text.text = [NSString stringWithFormat:@"%@个月(%li天)",arr[0], i ];
                
            }
            //
        }else{
            if ([arr[0] isEqualToString:@"不限"]) {
                NSString * str = [NSString stringWithFormat:@"%@",arr[1]];
                NSInteger i = [str integerValue] *30;
                weak_text.text = [NSString stringWithFormat:@"1~%@个月(30~%li天)",arr[1],i];
            }else{
                NSString * str = [NSString stringWithFormat:@"%@",arr[0]];
                NSInteger i = [str integerValue] *30;
                NSString * str2 = [NSString stringWithFormat:@"%@",arr[1]];
                NSInteger j = [str2 integerValue] *30;
                weak_text.text = [NSString stringWithFormat:@"%@~%@个月(%li天~%li天)",arr[0],arr[1],i,j];
            }
            
        }
        
    } cancelBlock:^{
        [weak_text endEditing:YES];
    }];
    
    UIView *paddingView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, 10, 20)];
    _YearsRateTF.leftView = paddingView;
    _YearsRateTF.leftViewMode = UITextFieldViewModeAlways;
}


- (IBAction)saveAndEntrustBtnClicked:(id)sender {
        NSMutableDictionary *params = [[UserinfoManager sharedUserinfo] increaseUserParams:nil];
    
    
    if (self.PlanNameTF.text.length >10 || self.PlanNameTF.text .length < 1  ) {
        [SpringAlertView showMessage:@"请输入方案名称"];
        return;
    }
    //方案名称
    [params setObject:self.PlanNameTF.text forKey:@"remark"];
    
    
    
    //利率
    NSArray *annualArr = [self.aprPickerView selectedInfo];
    if ([annualArr[0] isEqualToString:@"不限"]) {
        [params setObject:@"0" forKey:@"min_annual"];
    }else{
        [params setObject:annualArr[0] forKey:@"min_annual"];
    }
    if ([annualArr[1] isEqualToString:@"不限"]) {
        [params setObject:@"0" forKey:@"max_annual"];
    }else{
        [params setObject:annualArr[1] forKey:@"max_annual"];
    }
    
    
    //期限
    NSArray *dateArr = [self.dayPickerView selectedInfo];
    if ([dateArr[0] isEqualToString:@"不限"]) {
        [params setObject:@"0" forKey:@"min_unit"];
    }else{
        [params setObject:dateArr[0] forKey:@"min_unit"];
    }
    if ([dateArr[1] isEqualToString:@"不限"]) {
        [params setObject:@"0" forKey:@"max_unit"];
    }else{
        [params setObject:dateArr[1] forKey:@"max_unit"];
    }
    
    
    if ([annualArr[0] isEqualToString:@"不限"] &&[annualArr[1] isEqualToString:@"不限"]&&[dateArr[0] isEqualToString:@"不限"]&& [dateArr[1] isEqualToString:@"不限"]) {
        [SpringAlertView showMessage:@"请设置投资条件"];
        return;
    }

    
//    单笔固定投资 & 账户余额全部投资
    if (!self.SingleMoneyBtn.selected && !self.AllMoneyBtn.selected ) {
            [SpringAlertView showMessage:@"请选择投资方案"];
            return;
        }
    if (self.SingleMoneyBtn.selected  ) {
        if ( [self.MoneyTF.text integerValue]%100 != 0 || [self.MoneyTF.text integerValue] < 1000) {
            [SpringAlertView showMessage:NSLocalizedString(@"err_money", nil)];
            return;
        }

       
    }

    
    if (self.SingleMoneyBtn.selected) {
        [params setObject:@"0" forKey:@"all_amount"];
        [params setObject:self.MoneyTF.text forKey:@"amount"];
    }else{
         [params setObject:@"1" forKey:@"all_amount"];
    }
    
    
//   红包
    if (self.useRedSwitch.on) {
        [params setObject:@"1" forKey:@"is_red"];
    }else{
       [params setObject:@"0" forKey:@"is_red"];
    }
    
    
    
    ////    2.9、saveentrustdeposit （保存定期委托投资） => userid（用户uid）、mobile（手机号）、borrow_id（定期理财项目id）、amount（委托金额）、entrustdate（委托时间）
    ////    返回值 result=1表示委托成功；0表示委托失败
    //
    //    if (!self.entrustMoney.success || [self.entrustMoney.text integerValue]%100 != 0 || [self.entrustMoney.text integerValue] < 1000) {
    //        [SpringAlertView showMessage:NSLocalizedString(@"err_money", nil)];
    //        return;
    //    }
    //
    //    NSMutableDictionary *params = [[UserinfoManager sharedUserinfo] increaseUserParams:nil];
//        [params addEntriesFromDictionary:@{@"borrow_id":self.regularInfo[self.exclusiveButtons.invalidButton.tag][@"id"], @"amount": self.entrustMoney.text, @"entrustdate":self.entrustTime.text}];
    //
        @weakify(self)
        [self.baseViewModel postMethod:@"auto_save" params:params success:^(id result) {
            @strongify(self)
    
            [SpringAlertView showMessage:result[RESULT_REMARK]];
            [self.navigationController popViewControllerAnimated:YES];
            if (self.entrustSuccess) {
                self.entrustSuccess();
            }
        } failure:^(id result, NSString *errorDescription) {
            
            [SpringAlertView showMessage:errorDescription];
        }];
    
    
}


- (SinglePickerView *)dayPickerView {
    if (!_dayPickerView) {
        _dayPickerView = [[SinglePickerView alloc] init];
        _dayPickerView.frame = CGRectMake(0, 0, UISCREEN_WIDTH, 180);
    }
    return _dayPickerView;
}
- (SinglePickerView *)aprPickerView {
    if (!_aprPickerView) {
        _aprPickerView = [[SinglePickerView alloc] init];
        _aprPickerView.frame = CGRectMake(0, 0, UISCREEN_WIDTH, 180);
    }
    return _aprPickerView;
}


//- (void)fetchRegularEntrustInfo {
////    2.8、getentrustdepositproject （定期委托理财产品列表）
////    返回list  id（定期理财项目id）、period（期限《1、3、6、12月》）、apr（年化收益率）、projectname（名称）
//    [BaseIndicatorView showInView:self.view maskType:kIndicatorNoMask];
//    @weakify(self)
//    [self.baseViewModel postMethod:@"getentrustdepositproject" params:[[UserinfoManager sharedUserinfo] increaseUserParams:nil] success:^(id result) {
//        @strongify(self)
//        
//        [BaseIndicatorView hideWithAnimation:self.didShow];
//        self.regularInfo = result[RESULT_DATA];
//    } failure:^(id result, NSString *errorDescription) {
//        @strongify(self)
//        
//        [BaseIndicatorView hideWithAnimation:self.didShow];
//        [SpringAlertView showMessage:errorDescription];
//    }];
//}
//- (void)setRegularInfo:(NSArray *)regularInfo {
//    if (regularInfo.count < 4) return;
//    if ([_regularInfo isEqualToArray:regularInfo]) return;
//    
//    _regularInfo = regularInfo;
//    
//    for (RegularInfoView *view in self.regularInfoViews) {
//        [view loadInterfaceWithDictionary:regularInfo[view.tag]];
//    }
//    
//    self.contentView.hidden = NO;
//    self.saveAndEntrust.hidden = NO;
//}
//

//#pragma mark - action
//- (IBAction)entrust {
////    2.9、saveentrustdeposit （保存定期委托投资） => userid（用户uid）、mobile（手机号）、borrow_id（定期理财项目id）、amount（委托金额）、entrustdate（委托时间）
////    返回值 result=1表示委托成功；0表示委托失败
//    
//    if (!self.entrustMoney.success || [self.entrustMoney.text integerValue]%100 != 0 || [self.entrustMoney.text integerValue] < 1000) {
//        [SpringAlertView showMessage:NSLocalizedString(@"err_money", nil)];
//        return;
//    }
//    
//    NSMutableDictionary *params = [[UserinfoManager sharedUserinfo] increaseUserParams:nil];
//    [params addEntriesFromDictionary:@{@"borrow_id":self.regularInfo[self.exclusiveButtons.invalidButton.tag][@"id"], @"amount": self.entrustMoney.text, @"entrustdate":self.entrustTime.text}];
//    
//    @weakify(self)
//    [self.baseViewModel postMethod:@"saveentrustdeposit" params:params success:^(id result) {
//        @strongify(self)
//        
//        [SpringAlertView showMessage:result[RESULT_REMARK]];
//        [self.navigationController popViewControllerAnimated:YES];
//        if (self.entrustSuccess) {
//            self.entrustSuccess();
//        }
//    } failure:^(id result, NSString *errorDescription) {
//        
//        [SpringAlertView showMessage:errorDescription];
//    }];
//}
//
//
//- (IBAction)intoProtocol:(UIButton *)sender {
//    
//    [self.navigationController pushViewController:[WebVC webVCWithWebPath:[CommonTools completeWebPathWithSubpath:0 == sender.tag ? Introduce_Buy : Introduct_Entrust]] animated:YES];
//}
//
//#pragma mark - setter
//- (void)setRegularInfoViews:(NSArray<RegularInfoView *> *)regularInfoViews {
//    _regularInfoViews = regularInfoViews;
//    
//    for (RegularInfoView *view in regularInfoViews) {
//        if (0 == view.tag) {
//            [self.exclusiveButtons appendButton:view.clickButton invalid:YES];
//        } else {
//            [self.exclusiveButtons appendButton:view.clickButton invalid:NO];
//        }
//        view.clickButton.tag = view.tag;
//    }
//}
//- (void)setEntrustTime:(UITextField *)entrustTime {
//    _entrustTime = entrustTime;
//    
//    entrustTime.text = [self.dateFormat stringFromDate:[NSDate date]];
//    entrustTime.inputView = self.datePicker;
//    
//    @weakify(self);
//    entrustTime.inputAccessoryView = [PickerAccessoryView pickerAccessoryViewWithDoneBlock:^{
//        @strongify(self)
//        
//        [self.entrustTime endEditing:YES];
//        self.entrustTime.text = [self.dateFormat stringFromDate:self.datePicker.date];
//    } cancelBlock:^{
//        @strongify(self)
//        
//        [self.entrustTime endEditing:YES];
//    }];
//}
//- (void)setBalance:(UILabel *)balance {
//    _balance = balance;
//    
//    [RACObserve([UserinfoManager sharedUserinfo].userInfo, balance) subscribeNext:^(NSString *newBalance) {
//        balance.text = newBalance;
//    }];
//}
//
//#pragma mark - getter
- (BaseViewModel *)baseViewModel {
    if (!_baseViewModel) {
        _baseViewModel = [[BaseViewModel alloc] init];
    }
    return _baseViewModel;
}
//- (UIDatePicker *)datePicker {
//    
//    if (!_datePicker) {
//        _datePicker = [[UIDatePicker alloc] init];
//        _datePicker.datePickerMode = UIDatePickerModeDate;
//        _datePicker.minimumDate = [NSDate date];
//    }
//    return _datePicker;
//}
//- (NSDateFormatter *)dateFormat {
//    
//    if (!_dateFormat) {
//        _dateFormat = [[NSDateFormatter alloc] init];
//        _dateFormat.dateFormat = @"y/MM/dd";
//    }
//    return _dateFormat;
//}
@end
